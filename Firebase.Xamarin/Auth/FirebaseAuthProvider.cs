namespace Firebase.Xamarin.Auth
{
	using System;
	using System.Linq;
	using System.Net.Http;
	using System.Text;
	using System.Threading.Tasks;

	using Newtonsoft.Json;
	using Newtonsoft.Json.Linq;

	/// <summary>
	/// The auth token provider.
	/// </summary>
	public class FirebaseAuthProvider : IDisposable, IFirebaseAuthProvider
	{
		private const string GoogleIdentityUrl = "https://www.googleapis.com/identitytoolkit/v3/relyingparty/verifyAssertion?key={0}";
		private const string GoogleSignUpUrl = "https://www.googleapis.com/identitytoolkit/v3/relyingparty/signupNewUser?key={0}";
		private const string GooglePasswordUrl = "https://www.googleapis.com/identitytoolkit/v3/relyingparty/verifyPassword?key={0}";
		private const string GooglePasswordResetUrl = "https://www.googleapis.com/identitytoolkit/v3/relyingparty/getOobConfirmationCode?key={0}";
		private const string GoogleSetAccountUrl = "https://www.googleapis.com/identitytoolkit/v3/relyingparty/setAccountInfo?key={0}";

		private readonly FirebaseConfig authConfig;
		private readonly HttpClient client;

		/// <summary>
		/// Initializes a new instance of the <see cref="FirebaseAuthProvider"/> class.
		/// </summary>
		/// <param name="authConfig"> The auth config. </param>
		public FirebaseAuthProvider(FirebaseConfig authConfig)
		{
			this.authConfig = authConfig;
			this.client = new HttpClient();
		}

		/// <summary>
		/// Using the provided access token from third party auth provider (google, facebook...), get the firebase auth with token and basic user credentials.
		/// </summary>
		/// <param name="authType"> The auth type. </param>
		/// <param name="oauthAccessToken"> The access token retrieved from login provider of your choice. </param>
		/// <returns> The <see cref="FirebaseAuth"/>. </returns>
		public async Task<FirebaseAuthLink> SignInWithOAuthAsync(FirebaseAuthType authType, string oauthAccessToken)
		{
			var providerId = this.GetProviderId(authType);
			var content = $"{{\"postBody\":\"access_token={oauthAccessToken}&providerId={providerId}\",\"requestUri\":\"http://localhost\",\"returnSecureToken\":true}}";

			return await this.SignInWithPostContentAsync(GoogleIdentityUrl, content).ConfigureAwait(false);
		}

		/// <summary>
		/// Sign in user anonymously. He would still have a user id and access token generated, but name and other personal user properties will be null.
		/// </summary>
		/// <returns> The <see cref="FirebaseAuth"/>. </returns>
		public async Task<FirebaseAuthLink> SignInAnonymouslyAsync()
		{
			var content = $"{{\"returnSecureToken\":true}}";

			return await this.SignInWithPostContentAsync(GoogleSignUpUrl, content).ConfigureAwait(false);
		}

		/// <summary>
		/// Using the provided email and password, get the firebase auth with token and basic user credentials.
		/// </summary>
		/// <param name="email"> The email. </param>
		/// <param name="password"> The password. </param>
		/// <returns> The <see cref="FirebaseAuth"/>. </returns>
		public async Task<FirebaseAuthLink> SignInWithEmailAndPasswordAsync(string email, string password)
		{
			var content = $"{{\"email\":\"{email}\",\"password\":\"{password}\",\"returnSecureToken\":true}}";

			return await this.SignInWithPostContentAsync(GooglePasswordUrl, content).ConfigureAwait(false);
		}

		/// <summary>
		/// Creates new user with given credentials.
		/// </summary>
		/// <param name="email"> The email. </param>
		/// <param name="password"> The password. </param>
		/// <returns> The <see cref="FirebaseAuth"/>. </returns>
		public async Task<FirebaseAuthLink> CreateUserWithEmailAndPasswordAsync(string email, string password)
		{
			var content = $"{{\"email\":\"{email}\",\"password\":\"{password}\",\"returnSecureToken\":true}}";

			return await this.SignInWithPostContentAsync(GoogleSignUpUrl, content).ConfigureAwait(false);
		}

		/// <summary>
		/// Sends user an email with a link to reset his password.
		/// </summary>
		/// <param name="email"> The email. </param>
		public async Task SendPasswordResetEmailAsync(string email)
		{
			var content = $"{{\"requestType\":\"PASSWORD_RESET\",\"email\":\"{email}\"}}";

			var response = await this.client.PostAsync(new Uri(string.Format(GooglePasswordResetUrl, this.authConfig.ApiKey)), new StringContent(content, Encoding.UTF8, "application/json")).ConfigureAwait(false);

			response.EnsureSuccessStatusCode();
		}

		/// <summary>
		/// Links the authenticated user represented by <see cref="auth"/> with an email and password. 
		/// </summary>
		/// <param name="auth"> The authenticated user to link with specified email and password. </param>
		/// <param name="email"> The email. </param>
		/// <param name="password"> The password. </param>
		/// <returns> The <see cref="FirebaseAuthLink"/>. </returns>
		public async Task<FirebaseAuthLink> LinkAccountsAsync(FirebaseAuth auth, string email, string password)
		{
			var content = $"{{\"idToken\":\"{auth.FirebaseToken}\",\"email\":\"{email}\",\"password\":\"{password}\",\"returnSecureToken\":true}}";

			return await this.SignInWithPostContentAsync(GoogleSetAccountUrl, content).ConfigureAwait(false);
		}

		/// <summary>
		/// Links the authenticated user represented by <see cref="auth"/> with and account from a third party provider.
		/// </summary>
		/// <param name="auth"> The auth. </param>
		/// <param name="authType"> The auth type.  </param>
		/// <param name="oauthAccessToken"> The access token retrieved from login provider of your choice. </param>
		/// <returns> The <see cref="FirebaseAuthLink"/>.  </returns>
		public async Task<FirebaseAuthLink> LinkAccountsAsync(FirebaseAuth auth, FirebaseAuthType authType, string oauthAccessToken)
		{
			var providerId = this.GetProviderId(authType);
			var content = $"{{\"idToken\":\"{auth.FirebaseToken}\",\"postBody\":\"access_token={oauthAccessToken}&providerId={providerId}\",\"requestUri\":\"http://localhost\",\"returnSecureToken\":true}}";

			return await this.SignInWithPostContentAsync(GoogleIdentityUrl, content).ConfigureAwait(false);
		}

		/// <summary>
		/// Disposes all allocated resources. 
		/// </summary>
		public void Dispose()
		{
			this.client.Dispose();
		}

		private async Task<FirebaseAuthLink> SignInWithPostContentAsync(string googleUrl, string postContent)
		{
			var response = await this.client.PostAsync(new Uri(string.Format(googleUrl, this.authConfig.ApiKey)), new StringContent(postContent, Encoding.UTF8, "application/json")).ConfigureAwait(false);
			var responseData = await response.Content.ReadAsStringAsync().ConfigureAwait(false);

			if (!response.IsSuccessStatusCode)
			{
				var jsonReturn = JObject.Parse(responseData);
				var message = (string)jsonReturn["error"]["message"];

				// Login
				// Email address not found in database
				if (message.Equals("EMAIL_NOT_FOUND"))
				{
					throw new FirebaseInvalidEmailException("Email address not found");
				}
				// Login
				// Invalid password supplied
				else if (message.Equals("INVALID_PASSWORD"))
				{
					throw new FirebaseIncorrectPasswordException("Incorrect passord");
				}
				// New User
				// Email address already exists
				else if (message.Equals("EMAIL_EXISTS"))
				{
					throw new FirebaseUsedEmailException("Email address already exists");
				}
				// New User
				// Week Password
				else if (message.Contains("WEAK_PASSWORD"))
				{
					throw new FirebaseWeakPasswordException("Weak password, must be at least 6 characters");
				}
				// Just end on default status check
				else
				{
					response.EnsureSuccessStatusCode();
				}
			}

			var user = JsonConvert.DeserializeObject<User>(responseData);
			var auth = JsonConvert.DeserializeObject<FirebaseAuthLink>(responseData);

			auth.User = user;
			auth.AuthProvider = this;

			return auth;
		}

		private string GetProviderId(FirebaseAuthType authType)
		{
			switch (authType)
			{
				case FirebaseAuthType.Facebook:
					return "facebook.com";
				case FirebaseAuthType.Google:
					return "google.com";
				case FirebaseAuthType.Github:
					return "github.com";
				case FirebaseAuthType.Twitter:
					return "twitter.com";
				default: throw new NotImplementedException("");
			}
		}
	}
}
